plugins {
    id "de.undercouch.download" version "3.1.1"
}

allprojects  {
    group = 'enmasse'
}

ext {
    home = 'opt/apache-artemis-2.1.0'
}

import de.undercouch.gradle.tasks.download.Download

task fetchDependencies(type: Download) {
    src 'http://www-eu.apache.org/dist/activemq/activemq-artemis/2.1.0/apache-artemis-2.1.0-bin.tar.gz'
    dest new File(buildDir, 'apache-artemis-bin.tar.gz')
}

task buildArtemisBaseImage {
    doLast {
        exec {
            workingDir 'artemis-base-image'
            commandLine 'mvn', 'install'
        }
    }
}

task buildTar(type: Tar) {
    from('artemis-amqp-connector/build/libs/artemis-amqp-connector.jar') {
        into("${home}/lib")
    }
    from('config_templates') {
        into('config_templates')
    }
    from('utils') {
        into("${home}/bin/")
    }
    from(tarTree('artemis-shutdown-hook/build/distributions/artemis-shutdown-hook.tar')) {
        into("opt/")
    }
    archiveName 'artemis-image.tar'
    destinationDir file('build')
}

task pack {
    dependsOn buildTar
    dependsOn fetchDependencies
}
